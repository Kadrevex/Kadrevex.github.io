<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calorie & Protein Tracker</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f4;
    transition: 0.3s;
}

.dark-mode {
    background: #121212;
    color: white;
}

.container {
    padding: 20px;
}

input, button {
    width: 80%;
    padding: 14px;
    margin: 10px auto;
    font-size: 1.2rem;
    display: block;
    border-radius: 8px;
    border: none;
}

button {
    cursor: pointer;
    background: #333;
    color: white;
}

.dark-mode button {
    background: #444;
}

.progress-container {
    width: 80%;
    margin: 10px auto;
    background: #ddd;
    border-radius: 20px;
    overflow: hidden;
}

.dark-mode .progress-container {
    background: #333;
}

.progress-bar {
    height: 28px;
    width: 0%;
    transition: width 0.3s ease;
}

#calorieBar {
    background-color: #4da3ff;
}

#proteinBar {
    background-color: #ff3b3b;
}

.dark-mode #proteinBar {
    background-color: #ff4d4d;
}

.food-entry {
    margin: 8px 0;
    font-size: 1.2rem;
}

#scanner {
    width: 100%;
    height: 50vh;
    margin: 10px auto;
    display: none;
    overflow: hidden;
}

video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.popup {
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 12px;
    width: 85%;
    display: none;
    z-index: 1000;
}

.dark-mode .popup {
    background: #222;
    color: white;
}
</style>
</head>

<body>

<div class="container">

<h1>Daily Tracker</h1>

<h2>Calories</h2>
<div class="progress-container">
    <div id="calorieBar" class="progress-bar"></div>
</div>
<p id="calorieText">0 / 2000 kcal</p>

<h2>Protein</h2>
<div class="progress-container">
    <div id="proteinBar" class="progress-bar"></div>
</div>
<p id="proteinText">0 / 150 g</p>

<button onclick="startScanner()">Scan Barcode</button>

<div id="scanner"></div>

<h2>Manual Entry (per 100g)</h2>
<input type="text" id="manualName" placeholder="Food Name">
<input type="number" id="manualCalories" placeholder="Calories per 100g">
<input type="number" id="manualProtein" placeholder="Protein per 100g">
<input type="number" id="manualServings" placeholder="Servings (100g units)" value="1">
<button onclick="addManualFood()">Add Manually</button>

<button onclick="resetDay()">Reset Day</button>
<button onclick="toggleDarkMode()">Toggle Dark Mode</button>

<div id="foodList"></div>

</div>

<!-- Popup -->
<div id="confirmPopup" class="popup">
    <h3 id="popupName"></h3>
    <p id="popupInfo"></p>
    <input type="number" id="servingInput" value="1" min="1">
    <p>Servings (100g each)</p>
    <button onclick="confirmAdd()">Add Food</button>
    <button onclick="closePopup()">Cancel</button>
</div>

<script>
let totalCalories = 0;
let totalProtein = 0;
let calorieGoal = 2000;
let proteinGoal = 150;

let scannedFood = {
    name: "",
    caloriesPer100: 0,
    proteinPer100: 0
};

function updateBars() {
    const caloriePercent = Math.min((totalCalories / calorieGoal) * 100, 100);
    const proteinPercent = Math.min((totalProtein / proteinGoal) * 100, 100);

    document.getElementById("calorieBar").style.width = caloriePercent + "%";
    document.getElementById("proteinBar").style.width = proteinPercent + "%";

    document.getElementById("calorieText").textContent =
        `${totalCalories} / ${calorieGoal} kcal`;

    document.getElementById("proteinText").textContent =
        `${totalProtein} / ${proteinGoal} g`;
}

function addEntry(name, cal, prot) {
    totalCalories += cal;
    totalProtein += prot;
    updateBars();

    const entry = document.createElement("div");
    entry.className = "food-entry";
    entry.textContent = `${name} â€” ${cal} kcal | ${prot}g protein`;
    document.getElementById("foodList").appendChild(entry);
}

/* Manual */
function addManualFood() {
    const name = document.getElementById("manualName").value;
    const calPer100 = parseFloat(document.getElementById("manualCalories").value);
    const protPer100 = parseFloat(document.getElementById("manualProtein").value);
    const servings = parseFloat(document.getElementById("manualServings").value);

    if (!name || !calPer100 || !protPer100 || !servings) return;

    const totalCal = calPer100 * servings;
    const totalProt = protPer100 * servings;

    addEntry(name, totalCal, totalProt);

    document.getElementById("manualName").value = "";
    document.getElementById("manualCalories").value = "";
    document.getElementById("manualProtein").value = "";
    document.getElementById("manualServings").value = 1;
}

function resetDay() {
    totalCalories = 0;
    totalProtein = 0;
    document.getElementById("foodList").innerHTML = "";
    updateBars();
}

function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
}

/* Barcode Scanner */
function startScanner() {
    document.getElementById("scanner").style.display = "block";

    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector('#scanner'),
            constraints: { facingMode: "environment" }
        },
        decoder: {
            readers: ["ean_reader", "upc_reader"]
        }
    }, function(err) {
        if (!err) Quagga.start();
    });

    Quagga.onDetected(function(result) {
        Quagga.stop();
        document.getElementById("scanner").style.display = "none";
        lookupFood(result.codeResult.code);
    });
}

/* Fetch from OpenFoodFacts */
function lookupFood(barcode) {
    fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
    .then(res => res.json())
    .then(data => {
        if (data.status !== 1) {
            alert("Food not found.");
            return;
        }

        const product = data.product;

        scannedFood.name = product.product_name || "Unknown Food";
        scannedFood.caloriesPer100 = product.nutriments["energy-kcal_100g"] || 0;
        scannedFood.proteinPer100 = product.nutriments["proteins_100g"] || 0;

        document.getElementById("popupName").textContent = scannedFood.name;
        document.getElementById("popupInfo").textContent =
            `${scannedFood.caloriesPer100} kcal | ${scannedFood.proteinPer100}g protein per 100g`;

        document.getElementById("servingInput").value = 1;
        document.getElementById("confirmPopup").style.display = "block";
    });
}

function confirmAdd() {
    const servings = parseFloat(document.getElementById("servingInput").value);

    const totalCal = scannedFood.caloriesPer100 * servings;
    const totalProt = scannedFood.proteinPer100 * servings;

    addEntry(scannedFood.name, totalCal, totalProt);
    closePopup();
}

function closePopup() {
    document.getElementById("confirmPopup").style.display = "none";
}
</script>

</body>
</html>