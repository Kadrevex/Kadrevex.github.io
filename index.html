<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calorie & Protein Tracker</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f4;
    transition: 0.3s;
}

.dark-mode {
    background: #121212;
    color: white;
}

.container {
    padding: 20px;
}

input, button {
    width: 80%;
    padding: 14px;
    margin: 10px auto;
    font-size: 1.2rem;
    display: block;
    border-radius: 8px;
    border: none;
}

button {
    cursor: pointer;
    background: #333;
    color: white;
}

.dark-mode button {
    background: #444;
}

.dark-mode input {
    background: #2a2a2a;
    color: white;
    border: 1px solid #555;
}

.progress-container {
    width: 80%;
    margin: 10px auto;
    background: #ddd;
    border-radius: 20px;
    overflow: hidden;
}

.dark-mode .progress-container {
    background: #333;
}

.progress-bar {
    height: 28px;
    width: 0%;
    transition: width 0.3s ease;
}

#calorieBar {
    background-color: #4da3ff;
}

#proteinBar {
    background-color: #ff3b3b;
}

.dark-mode #proteinBar {
    background-color: #ff4d4d;
}

.food-entry {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 80%;
    margin: 8px auto;
    font-size: 1rem;
    gap: 8px;
    text-align: left;
}

.food-entry span {
    flex: 1;
}

.log-remove {
    width: auto !important;
    padding: 5px 10px !important;
    margin: 0 !important;
    font-size: 0.85rem !important;
    background: #aa2222 !important;
    flex-shrink: 0;
}

/* Scanner close button */
#scanner-close {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 10;
    width: auto;
    padding: 7px 14px;
    margin: 0;
    font-size: 1rem;
    background: rgba(0, 0, 0, 0.65);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

/* Scanner: stays inside its panel */
#scanner {
    position: relative;
    width: 80%;
    max-width: 500px;
    height: 260px;
    margin: 10px auto;
    display: none;
    overflow: hidden;
    border-radius: 8px;
    background: #000;
}

#scanner video,
#scanner canvas {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
}

.popup {
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 12px;
    width: 85%;
    display: none;
    z-index: 1000;
}

.dark-mode .popup {
    background: #222;
    color: white;
}

/* Saved foods */
.saved-food-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 80%;
    margin: 8px auto;
    background: #e0e0e0;
    border-radius: 8px;
    padding: 10px 14px;
    box-sizing: border-box;
    text-align: left;
    gap: 8px;
}

.dark-mode .saved-food-card {
    background: #2a2a2a;
    color: white;
}

.saved-food-card .food-info {
    flex: 1;
    font-size: 1rem;
}

.saved-food-card .food-actions {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}

.saved-food-card .food-actions input[type="number"] {
    width: 55px;
    padding: 6px;
    margin: 0;
    font-size: 0.9rem;
    border-radius: 4px;
    border: 1px solid #ccc;
    display: inline-block;
    background: white;
    color: #333;
}

.dark-mode .saved-food-card .food-actions input[type="number"] {
    background: #1a1a1a;
    color: white;
    border-color: #555;
}

.saved-food-card .food-actions button {
    width: auto;
    padding: 7px 12px;
    margin: 0;
    font-size: 0.9rem;
    display: inline-block;
}

.btn-remove {
    background: #aa2222 !important;
}

.btn-save {
    background: #226622 !important;
}

#no-saved-msg {
    font-size: 1rem;
    color: #888;
    margin: 8px 0;
}

/* Daily goals row */
.goals-row {
    display: flex;
    justify-content: center;
    gap: 10px;
    width: 80%;
    margin: 4px auto 0;
}

.goals-row label {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    font-size: 0.85rem;
    color: #666;
    flex: 1;
}

.dark-mode .goals-row label {
    color: #aaa;
}

.goals-row input[type="number"] {
    width: 100%;
    padding: 10px;
    margin: 4px 0 0;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

.dark-mode .goals-row input[type="number"] {
    background: #2a2a2a;
    color: white;
    border-color: #555;
}

.btn-goals {
    background: #5577dd !important;
}

/* Food name search dropdown */
.search-wrap {
    position: relative;
    width: 80%;
    margin: 10px auto;
}

.search-wrap > input {
    width: 100%;
    margin: 0;
    box-sizing: border-box;
}

.search-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 600;
    display: none;
    text-align: left;
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}

.dark-mode .search-dropdown {
    background: #1e1e1e;
    border-color: #555;
}

.search-item {
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.dark-mode .search-item {
    border-bottom-color: #333;
}

.search-item:last-child {
    border-bottom: none;
}

.search-item:hover {
    background: #eef2ff;
}

.dark-mode .search-item:hover {
    background: #2a2a3a;
}

.search-item-name {
    font-size: 1rem;
    font-weight: bold;
}

.search-item-info {
    font-size: 0.8rem;
    color: #888;
    margin-top: 2px;
}

.dark-mode .search-item-info {
    color: #aaa;
}

.search-status {
    padding: 10px 14px;
    font-size: 0.95rem;
    color: #888;
    font-style: italic;
}
</style>
</head>

<body>

<div class="container">

<h1>Daily Tracker</h1>

<h2>Calories</h2>
<div class="progress-container">
    <div id="calorieBar" class="progress-bar"></div>
</div>
<p id="calorieText">0 / 2000 kcal</p>

<h2>Protein</h2>
<div class="progress-container">
    <div id="proteinBar" class="progress-bar"></div>
</div>
<p id="proteinText">0 / 150 g</p>

<h2>Daily Goals</h2>
<div class="goals-row">
    <label>
        Calorie goal (kcal)
        <input type="number" id="goalCalories" value="2000" min="1">
    </label>
    <label>
        Protein goal (g)
        <input type="number" id="goalProtein" value="150" min="1">
    </label>
</div>
<button class="btn-goals" onclick="setGoals()">Set Goals</button>

<button onclick="startScanner()">Scan Barcode</button>

<div id="scanner">
    <button id="scanner-close" onclick="stopScanner()">✕ Close</button>
</div>

<h2>Manual Entry (per 100g)</h2>
<div class="search-wrap">
    <input type="text" id="manualName" placeholder="Food Name" autocomplete="off" oninput="onNameInput()">
    <div id="searchDropdown" class="search-dropdown"></div>
</div>
<input type="number" id="manualCalories" placeholder="Calories per 100g">
<input type="number" id="manualProtein" placeholder="Protein per 100g">
<input type="number" id="manualServings" placeholder="Servings (100g units)" value="1">
<button onclick="addManualFood()">Add to Today</button>
<button class="btn-save" onclick="saveManualToFavorites()">Save as Favourite</button>

<button onclick="resetDay()">Reset Day</button>
<button onclick="toggleDarkMode()">Toggle Dark Mode</button>

<h2>Today's Log</h2>
<div id="foodList"></div>

<h2>Saved Foods</h2>
<p id="no-saved-msg">No saved foods yet.</p>
<div id="savedFoodsList"></div>

</div>

<!-- Barcode confirm popup -->
<div id="confirmPopup" class="popup">
    <h3 id="popupName"></h3>
    <p id="popupInfo"></p>
    <input type="number" id="servingInput" value="1" min="0.1" step="0.1">
    <p>Servings (100g each)</p>
    <button onclick="confirmAdd()">Add to Today</button>
    <button class="btn-save" onclick="saveScannedToFavourites()">Save as Favourite</button>
    <button onclick="closePopup()">Cancel</button>
</div>

<script>
const STATE_KEY = 'trackerState';

let totalCalories = 0;
let totalProtein  = 0;
let calorieGoal   = 2000;
let proteinGoal   = 150;
let foodLog       = []; // { name, cal, prot }
let savedFoods    = []; // { name, caloriesPer100, proteinPer100 }

let scannedFood = { name: "", caloriesPer100: 0, proteinPer100: 0 };

/* ── Persistence ────────────────────────────────────────────── */

function saveState() {
    const state = {
        totalCalories,
        totalProtein,
        calorieGoal,
        proteinGoal,
        darkMode: document.body.classList.contains('dark-mode'),
        foodLog,
        savedFoods
    };
    try { localStorage.setItem(STATE_KEY, JSON.stringify(state)); } catch(e) {}
}

function loadState() {
    let raw;
    try { raw = localStorage.getItem(STATE_KEY); } catch(e) {}
    if (!raw) return;
    try {
        const s = JSON.parse(raw);
        totalCalories = s.totalCalories || 0;
        totalProtein  = s.totalProtein  || 0;
        calorieGoal   = s.calorieGoal   || 2000;
        proteinGoal   = s.proteinGoal   || 150;

        if (s.darkMode) document.body.classList.add('dark-mode');

        document.getElementById('goalCalories').value = calorieGoal;
        document.getElementById('goalProtein').value  = proteinGoal;

        foodLog    = s.foodLog    || [];
        savedFoods = s.savedFoods || [];

        foodLog.forEach((item, i) => renderFoodEntry(item.name, item.cal, item.prot, i));
        savedFoods.forEach((food, i) => renderSavedFood(food, i));
        updateSavedMsg();
        updateBars();
    } catch(e) {
        console.error('State load failed', e);
    }
}

/* ── Progress bars ──────────────────────────────────────────── */

function updateBars() {
    const calPct  = Math.min((totalCalories / calorieGoal) * 100, 100);
    const protPct = Math.min((totalProtein  / proteinGoal) * 100, 100);

    document.getElementById('calorieBar').style.width = calPct + '%';
    document.getElementById('proteinBar').style.width = protPct + '%';

    document.getElementById('calorieText').textContent =
        `${Math.round(totalCalories)} / ${calorieGoal} kcal`;
    document.getElementById('proteinText').textContent =
        `${Math.round(totalProtein)} / ${proteinGoal} g`;
}

/* ── Today's log ────────────────────────────────────────────── */

function renderFoodEntry(name, cal, prot, index) {
    const el = document.createElement('div');
    el.className = 'food-entry';
    el.innerHTML = `
        <span>${name} — ${Math.round(cal)} kcal | ${Math.round(prot)}g protein</span>
        <button class="log-remove" onclick="removeLogEntry(${index})">✕</button>
    `;
    document.getElementById('foodList').appendChild(el);
}

function removeLogEntry(index) {
    totalCalories -= foodLog[index].cal;
    totalProtein  -= foodLog[index].prot;
    foodLog.splice(index, 1);
    const list = document.getElementById('foodList');
    list.innerHTML = '';
    foodLog.forEach((item, i) => renderFoodEntry(item.name, item.cal, item.prot, i));
    updateBars();
    saveState();
}

function addEntry(name, cal, prot) {
    totalCalories += cal;
    totalProtein  += prot;
    foodLog.push({ name, cal, prot });
    renderFoodEntry(name, cal, prot, foodLog.length - 1);
    updateBars();
    saveState();
}

/* ── Food name search ───────────────────────────────────────── */

let searchTimer = null;

function onNameInput() {
    const query = document.getElementById('manualName').value.trim();
    clearTimeout(searchTimer);
    if (query.length < 2) { closeDropdown(); return; }
    searchTimer = setTimeout(() => searchFood(query), 500);
}

function searchFood(query) {
    const dd = document.getElementById('searchDropdown');
    dd.innerHTML = '<div class="search-status">Searching…</div>';
    dd.style.display = 'block';

    fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=10&fields=product_name,nutriments`)
    .then(r => r.json())
    .then(data => {
        const products = (data.products || []).filter(p =>
            p.product_name && p.nutriments &&
            (p.nutriments['energy-kcal_100g'] != null || p.nutriments['energy_100g'] != null)
        );

        if (products.length === 0) {
            dd.innerHTML = '<div class="search-status">No results found.</div>';
            return;
        }

        dd.innerHTML = '';
        products.forEach(p => {
            const cal  = p.nutriments['energy-kcal_100g'] ??
                         Math.round((p.nutriments['energy_100g'] || 0) / 4.184);
            const prot = p.nutriments['proteins_100g'] || 0;

            const item = document.createElement('div');
            item.className = 'search-item';
            item.innerHTML = `
                <div class="search-item-name">${p.product_name}</div>
                <div class="search-item-info">${Math.round(cal)} kcal | ${Math.round(prot * 10) / 10}g protein per 100g</div>
            `;
            // mousedown fires before blur so the input doesn't lose focus before we read it
            item.addEventListener('mousedown', e => {
                e.preventDefault();
                selectResult(p.product_name, cal, prot);
            });
            dd.appendChild(item);
        });
    })
    .catch(() => {
        dd.innerHTML = '<div class="search-status">Search failed — enter values manually.</div>';
    });
}

function selectResult(name, cal, prot) {
    document.getElementById('manualName').value     = name;
    document.getElementById('manualCalories').value = Math.round(cal * 10) / 10;
    document.getElementById('manualProtein').value  = Math.round(prot * 10) / 10;
    closeDropdown();
}

function closeDropdown() {
    const dd = document.getElementById('searchDropdown');
    dd.style.display = 'none';
    dd.innerHTML = '';
}

document.addEventListener('click', e => {
    if (!document.querySelector('.search-wrap').contains(e.target)) closeDropdown();
});

/* ── Manual entry ───────────────────────────────────────────── */

function getManualFields() {
    return {
        name:       document.getElementById('manualName').value.trim(),
        calPer100:  parseFloat(document.getElementById('manualCalories').value),
        protPer100: parseFloat(document.getElementById('manualProtein').value),
        servings:   parseFloat(document.getElementById('manualServings').value)
    };
}

function clearManualFields() {
    document.getElementById('manualName').value     = '';
    document.getElementById('manualCalories').value = '';
    document.getElementById('manualProtein').value  = '';
    document.getElementById('manualServings').value = 1;
}

function addManualFood() {
    const { name, calPer100, protPer100, servings } = getManualFields();
    if (!name || isNaN(calPer100) || isNaN(protPer100) || isNaN(servings)) return;
    addEntry(name, calPer100 * servings, protPer100 * servings);
    clearManualFields();
}

function saveManualToFavorites() {
    const { name, calPer100, protPer100 } = getManualFields();
    if (!name || isNaN(calPer100) || isNaN(protPer100)) return;
    addToFavourites(name, calPer100, protPer100);
    clearManualFields();
}

/* ── Saved / favourite foods ────────────────────────────────── */

function updateSavedMsg() {
    document.getElementById('no-saved-msg').style.display =
        savedFoods.length === 0 ? 'block' : 'none';
}

function addToFavourites(name, caloriesPer100, proteinPer100) {
    if (savedFoods.some(f => f.name.toLowerCase() === name.toLowerCase())) {
        alert(`"${name}" is already in your saved foods.`);
        return;
    }
    const food = { name, caloriesPer100, proteinPer100 };
    savedFoods.push(food);
    renderSavedFood(food, savedFoods.length - 1);
    updateSavedMsg();
    saveState();
}

function renderSavedFood(food, index) {
    const card = document.createElement('div');
    card.className = 'saved-food-card';
    card.id = `saved-card-${index}`;
    card.innerHTML = `
        <div class="food-info">
            <strong>${food.name}</strong><br>
            <small>${food.caloriesPer100} kcal | ${food.proteinPer100}g protein per 100g</small>
        </div>
        <div class="food-actions">
            <input type="number" id="saved-serving-${index}" value="1" min="0.1" step="0.1">
            <button onclick="quickAdd(${index})">Add</button>
            <button class="btn-remove" onclick="removeSaved(${index})">✕</button>
        </div>
    `;
    document.getElementById('savedFoodsList').appendChild(card);
}

function quickAdd(index) {
    const food = savedFoods[index];
    const servings = parseFloat(document.getElementById(`saved-serving-${index}`).value) || 1;
    addEntry(food.name, food.caloriesPer100 * servings, food.proteinPer100 * servings);
    document.getElementById(`saved-serving-${index}`).value = 1;
}

function removeSaved(index) {
    savedFoods.splice(index, 1);
    // Full re-render so indices stay correct
    const list = document.getElementById('savedFoodsList');
    list.innerHTML = '';
    savedFoods.forEach((food, i) => renderSavedFood(food, i));
    updateSavedMsg();
    saveState();
}

/* ── Daily goals ────────────────────────────────────────────── */

function setGoals() {
    const newCal  = parseInt(document.getElementById('goalCalories').value);
    const newProt = parseInt(document.getElementById('goalProtein').value);
    if (isNaN(newCal) || newCal < 1 || isNaN(newProt) || newProt < 1) return;
    calorieGoal = newCal;
    proteinGoal = newProt;
    updateBars();
    saveState();
}

/* ── Reset / dark mode ──────────────────────────────────────── */

function resetDay() {
    totalCalories = 0;
    totalProtein  = 0;
    foodLog       = [];
    document.getElementById('foodList').innerHTML = '';
    updateBars();
    saveState();
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    saveState();
}

/* ── Barcode scanner ────────────────────────────────────────── */

function startScanner() {
    document.getElementById('scanner').style.display = 'block';

    Quagga.init({
        inputStream: {
            type: 'LiveStream',
            target: document.querySelector('#scanner'),
            constraints: { facingMode: 'environment' }
        },
        decoder: { readers: ['ean_reader', 'upc_reader'] }
    }, function(err) {
        if (!err) Quagga.start();
    });

    Quagga.onDetected(function(result) {
        Quagga.stop();
        document.getElementById('scanner').style.display = 'none';
        lookupFood(result.codeResult.code);
    });
}

function stopScanner() {
    Quagga.stop();
    document.getElementById('scanner').style.display = 'none';
}

function lookupFood(barcode) {
    fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
    .then(res => res.json())
    .then(data => {
        if (data.status !== 1) { alert('Food not found.'); return; }

        const p = data.product;
        scannedFood.name          = p.product_name || 'Unknown Food';
        scannedFood.caloriesPer100 = p.nutriments['energy-kcal_100g'] || 0;
        scannedFood.proteinPer100  = p.nutriments['proteins_100g']     || 0;

        document.getElementById('popupName').textContent = scannedFood.name;
        document.getElementById('popupInfo').textContent =
            `${scannedFood.caloriesPer100} kcal | ${scannedFood.proteinPer100}g protein per 100g`;

        document.getElementById('servingInput').value = 1;
        document.getElementById('confirmPopup').style.display = 'block';
    });
}

function confirmAdd() {
    const servings = parseFloat(document.getElementById('servingInput').value) || 1;
    addEntry(scannedFood.name,
             scannedFood.caloriesPer100 * servings,
             scannedFood.proteinPer100  * servings);
    closePopup();
}

function saveScannedToFavourites() {
    addToFavourites(scannedFood.name, scannedFood.caloriesPer100, scannedFood.proteinPer100);
    closePopup();
}

function closePopup() {
    document.getElementById('confirmPopup').style.display = 'none';
}

/* ── Init ───────────────────────────────────────────────────── */
loadState();
</script>

</body>
</html>
